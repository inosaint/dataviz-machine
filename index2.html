<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professor DataViz's Laboratory</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Gochi+Hand&family=Permanent+Marker&display=swap" rel="stylesheet">
    <style>
        :root {
            --sky: #b8e6ff;
            --sky-bottom: #e8f4ff;
            --ground: #7cb342;
            --ground-dark: #558b2f;
            --wall: #f5e6c8;
            --wall-dark: #d4c4a0;
            --brick: #c9a882;
            --metal: #8899aa;
            --metal-light: #b0c4d8;
            --metal-dark: #5c6b7a;
            --wood: #a0764a;
            --wood-dark: #7a5a38;
            --danger-red: #e53935;
            --happy-green: #43a047;
            --electric-yellow: #fdd835;
            --goo-purple: #9c27b0;
            --science-blue: #1e88e5;
            --ink: #222;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Gochi Hand', cursive;
            color: var(--ink);
            overflow-x: hidden;
            min-height: 100vh;
            background: linear-gradient(180deg, var(--sky) 0%, var(--sky-bottom) 60%, var(--ground) 60%, var(--ground-dark) 100%);
            background-attachment: fixed;
        }

        /* ---- CLOUDS ---- */
        .clouds { position: fixed; top: 0; left: 0; right: 0; height: 200px; pointer-events: none; z-index: 0; overflow: hidden; }
        .cloud { position: absolute; background: #fff; border-radius: 50%; opacity: 0.85; }
        .cloud::before, .cloud::after { content: ''; position: absolute; background: #fff; border-radius: 50%; }
        .cloud-1 { width: 120px; height: 50px; top: 30px; animation: drift 40s linear infinite; }
        .cloud-1::before { width: 70px; height: 50px; top: -25px; left: 20px; }
        .cloud-1::after { width: 50px; height: 40px; top: -15px; left: 60px; }
        .cloud-2 { width: 90px; height: 40px; top: 70px; animation: drift 55s linear infinite; animation-delay: -15s; }
        .cloud-2::before { width: 50px; height: 40px; top: -20px; left: 15px; }
        .cloud-2::after { width: 40px; height: 30px; top: -10px; left: 45px; }
        .cloud-3 { width: 150px; height: 55px; top: 20px; animation: drift 70s linear infinite; animation-delay: -35s; }
        .cloud-3::before { width: 80px; height: 55px; top: -30px; left: 30px; }
        .cloud-3::after { width: 60px; height: 45px; top: -20px; left: 80px; }
        @keyframes drift { 0% { left: -200px; } 100% { left: 110%; } }

        /* ---- WRAPPER ---- */
        .factory-wrapper { position: relative; z-index: 1; max-width: 900px; margin: 0 auto; padding: 20px 16px 60px; }

        /* ---- SIGN ---- */
        .factory-sign {
            background: var(--electric-yellow);
            border: 4px solid var(--ink);
            border-radius: 18px;
            padding: 16px 30px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 6px 6px 0 rgba(0,0,0,0.15);
            transform: rotate(-1deg);
            position: relative;
        }
        .factory-sign h1 {
            font-family: 'Bangers', cursive;
            font-size: 2.6rem;
            color: var(--ink);
            letter-spacing: 0.06em;
            text-shadow: 2px 2px 0 rgba(0,0,0,0.1);
            line-height: 1.1;
        }
        .factory-sign .tagline { font-size: 1rem; margin-top: 4px; color: #555; }
        .sign-bolt { position: absolute; top: -10px; width: 20px; height: 20px; background: radial-gradient(circle at 40% 35%, #ddd, #888); border: 2px solid #444; border-radius: 50%; }
        .sign-bolt.left { left: 30px; }
        .sign-bolt.right { right: 30px; }
        .sign-chain { position: absolute; top: -24px; width: 4px; height: 18px; background: repeating-linear-gradient(180deg, #888 0px, #888 3px, #bbb 3px, #bbb 6px); }
        .sign-chain.left { left: 38px; }
        .sign-chain.right { right: 38px; }

        /* ---- PROFESSOR ---- */
        .professor-area { display: flex; align-items: flex-start; gap: 16px; margin-bottom: 20px; }
        .professor-svg { flex-shrink: 0; width: 100px; height: 140px; filter: drop-shadow(3px 3px 0 rgba(0,0,0,0.12)); }
        .professor-speech {
            position: relative;
            background: #fff;
            border: 3px solid var(--ink);
            border-radius: 20px;
            padding: 14px 18px;
            font-size: 1.15rem;
            line-height: 1.4;
            box-shadow: 4px 4px 0 rgba(0,0,0,0.1);
            max-width: 500px;
        }
        .professor-speech::before { content: ''; position: absolute; left: -18px; top: 30px; border: 10px solid transparent; border-right-color: var(--ink); }
        .professor-speech::after { content: ''; position: absolute; left: -13px; top: 33px; border: 7px solid transparent; border-right-color: #fff; }
        #speechText { transition: opacity 0.3s; }

        /* ---- FACTORY BUILDING ---- */
        .factory-floor {
            background: var(--wall);
            border: 4px solid var(--ink);
            border-radius: 16px;
            position: relative;
            overflow: visible;
            box-shadow: 8px 8px 0 rgba(0,0,0,0.12);
        }
        .brick-top {
            height: 28px;
            background: repeating-linear-gradient(90deg, var(--brick) 0px, var(--brick) 50px, var(--wall-dark) 50px, var(--wall-dark) 52px);
            border-bottom: 3px solid var(--ink);
            border-radius: 12px 12px 0 0;
            position: relative;
        }
        .brick-top::after {
            content: 'ASSEMBLY LINE';
            position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%);
            font-family: 'Bangers', cursive; font-size: 0.75rem; letter-spacing: 0.3em; color: #777;
        }

        /* ---- STATION ---- */
        .station { padding: 24px 22px; position: relative; border-bottom: 3px dashed #c4b090; transition: background 0.3s; }
        .station:last-child { border-bottom: none; }
        .station.active { background: rgba(255,255,100,0.08); }
        .station.done-bg { background: rgba(100,255,100,0.06); }
        .station.locked { opacity: 0.5; pointer-events: none; }
        .station-header { display: flex; align-items: center; gap: 14px; margin-bottom: 14px; }
        .station-number {
            width: 48px; height: 48px; border-radius: 50%; border: 3px solid var(--ink);
            display: flex; align-items: center; justify-content: center;
            font-family: 'Bangers', cursive; font-size: 1.6rem; color: #fff; flex-shrink: 0;
            box-shadow: 3px 3px 0 rgba(0,0,0,0.15); position: relative;
        }
        .station-number.blue { background: var(--science-blue); }
        .station-number.purple { background: var(--goo-purple); }
        .station-number.red { background: var(--danger-red); }
        .station-number .spin-ring {
            position: absolute; inset: -6px; border: 3px solid transparent;
            border-top-color: var(--electric-yellow); border-radius: 50%; opacity: 0;
        }
        .station.active .station-number .spin-ring { opacity: 1; animation: spin 0.8s linear infinite; }
        .station-title { font-family: 'Permanent Marker', cursive; font-size: 1.4rem; }
        .station-subtitle { font-size: 0.85rem; color: #777; }
        .station-illustration { float: right; margin: 0 0 10px 16px; }

        /* ---- CONVEYOR ---- */
        .conveyor {
            height: 26px; background: #555; border: 3px solid var(--ink);
            position: relative; overflow: hidden; margin: 0 -4px;
            box-shadow: inset 0 4px 8px rgba(0,0,0,0.3);
        }
        .conveyor-belt { position: absolute; inset: 3px 0; background: repeating-linear-gradient(90deg, #666 0px, #666 18px, #777 18px, #777 20px); background-size: 20px 100%; }
        .conveyor.running .conveyor-belt { animation: conveyorMove 1s linear infinite; }
        .conveyor-rollers { position: absolute; bottom: -3px; left: 0; right: 0; display: flex; justify-content: space-around; pointer-events: none; }
        .roller { width: 18px; height: 18px; background: radial-gradient(circle at 40% 35%, var(--metal-light), var(--metal-dark)); border: 2px solid var(--ink); border-radius: 50%; }
        .conveyor.running .roller { animation: spin 1s linear infinite; }
        @keyframes conveyorMove { 0% { transform: translateX(0); } 100% { transform: translateX(-20px); } }

        /* ---- INPUTS ---- */
        .input-area { margin: 10px 0; }
        .input-row { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; font-size: 1.2rem; margin: 8px 0; }
        input, select, textarea {
            font-family: 'Gochi Hand', cursive; font-size: 1.15rem;
            border: 3px solid var(--ink); background: #fff; color: var(--ink);
            padding: 6px 12px; border-radius: 10px; outline: none; min-width: 90px;
            box-shadow: inset 2px 2px 0 rgba(0,0,0,0.06), 3px 3px 0 rgba(0,0,0,0.08);
        }
        input:focus, select:focus, textarea:focus { border-color: var(--science-blue); box-shadow: 0 0 0 3px rgba(30,136,229,0.15); }

        /* ---- LEVER BUTTON ---- */
        .lever-btn-wrapper { display: flex; justify-content: center; margin: 18px 0 6px; }
        .lever-btn { position: relative; width: 140px; height: 70px; cursor: pointer; background: none; border: none; box-shadow: none; padding: 0; margin: 0; }
        .lever-btn:hover, .lever-btn:active { transform: none; box-shadow: none; }
        .lever-base { position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 70px; height: 24px; background: linear-gradient(180deg, var(--metal-light), var(--metal-dark)); border: 3px solid var(--ink); border-radius: 6px; box-shadow: 3px 3px 0 rgba(0,0,0,0.15); }
        .lever-handle { position: absolute; bottom: 18px; left: 50%; width: 12px; height: 50px; background: linear-gradient(90deg, #c62828, #e53935, #c62828); border: 3px solid var(--ink); border-radius: 6px; transform-origin: bottom center; transform: translateX(-50%) rotate(-25deg); transition: transform 0.3s cubic-bezier(.68,-0.55,.27,1.55); }
        .lever-btn:hover .lever-handle { transform: translateX(-50%) rotate(-15deg); }
        .lever-btn.pulled .lever-handle { transform: translateX(-50%) rotate(25deg); }
        .lever-knob { position: absolute; top: -14px; left: 50%; transform: translateX(-50%); width: 28px; height: 28px; background: radial-gradient(circle at 40% 35%, #ff5252, #c62828); border: 3px solid var(--ink); border-radius: 50%; box-shadow: 2px 2px 0 rgba(0,0,0,0.2); }
        .lever-label { position: absolute; bottom: -22px; left: 50%; transform: translateX(-50%); font-family: 'Bangers', cursive; font-size: 0.85rem; letter-spacing: 0.1em; color: #666; white-space: nowrap; }

        /* ---- COMIC BURST ---- */
        .burst {
            position: fixed; z-index: 100; pointer-events: none;
            font-family: 'Bangers', cursive; font-size: 3rem; color: var(--ink);
            text-shadow: 2px 2px 0 var(--electric-yellow); opacity: 0;
            transform: scale(0.3) rotate(-10deg);
        }
        .burst.show { animation: burstAnim 1s ease-out forwards; }
        @keyframes burstAnim {
            0% { opacity: 0; transform: scale(0.3) rotate(-10deg); }
            30% { opacity: 1; transform: scale(1.2) rotate(3deg); }
            60% { opacity: 1; transform: scale(1) rotate(0deg); }
            100% { opacity: 0; transform: scale(1.3) rotate(-5deg); }
        }

        /* ---- BULB INDICATORS ---- */
        .bulb-row { display: flex; gap: 8px; margin-top: 10px; }
        .bulb { width: 18px; height: 22px; border: 2px solid var(--ink); border-radius: 50% 50% 40% 40%; background: #555; position: relative; transition: background 0.3s, box-shadow 0.3s; }
        .bulb::after { content: ''; position: absolute; bottom: -5px; left: 50%; transform: translateX(-50%); width: 10px; height: 5px; background: var(--metal); border: 1px solid var(--ink); border-radius: 0 0 3px 3px; }
        .bulb.on-green { background: var(--happy-green); box-shadow: 0 0 10px rgba(67,160,71,0.6); }
        .bulb.on-yellow { background: var(--electric-yellow); box-shadow: 0 0 10px rgba(253,216,53,0.6); animation: bulbFlicker 0.6s infinite alternate; }
        .bulb.on-red { background: var(--danger-red); box-shadow: 0 0 10px rgba(229,57,53,0.5); }
        @keyframes bulbFlicker { 0% { opacity: 0.7; } 100% { opacity: 1; } }

        /* ---- ACCORDION ---- */
        .accordion { margin-top: 14px; }
        .accordion-header {
            width: 100%; background: var(--wood); color: #fff; border: 3px solid var(--ink);
            padding: 8px 14px; text-align: left; cursor: pointer; border-radius: 10px;
            display: flex; justify-content: space-between; align-items: center;
            font-family: 'Bangers', cursive; font-size: 0.95rem; letter-spacing: 0.06em;
            box-shadow: 3px 3px 0 rgba(0,0,0,0.12); margin: 0;
        }
        .accordion-header:hover { background: var(--wood-dark); transform: none; box-shadow: 3px 3px 0 rgba(0,0,0,0.12); }
        .accordion-header:active { transform: none; box-shadow: 2px 2px 0 rgba(0,0,0,0.12); }
        .accordion-header::after { content: '\25bc'; transition: transform 0.2s; }
        .accordion-header[aria-expanded="true"]::after { transform: rotate(180deg); }
        .accordion-body { max-height: 0; overflow: hidden; transition: max-height 0.35s ease; }
        .accordion-body.expanded { max-height: 1200px; }
        .output-slot { padding: 14px; background: #fff; border: 2px solid #ccc; border-radius: 8px; font-size: 1rem; min-height: 36px; white-space: pre-wrap; margin-top: 8px; color: var(--ink); }
        .source-tag { font-size: 0.8rem; background: #f0e8d8; padding: 2px 8px; border: 1px dashed #aaa; border-radius: 4px; display: inline-block; margin-top: 8px; color: #666; }
        .loading-text { display: none; text-align: center; font-size: 1.05rem; color: #888; margin-top: 8px; font-style: italic; }
        textarea#promptOutput { width: 100%; min-height: 80px; resize: vertical; border: 2px solid #ccc; border-radius: 8px; padding: 10px; margin-top: 8px; background: #fff; color: var(--ink); }

        /* ---- PRINTER OUTPUT ---- */
        .printer-station { background: var(--wall-dark); border-top: 4px solid var(--ink); padding: 20px 22px; border-radius: 0 0 12px 12px; }
        .printer-mouth { width: 70%; height: 18px; margin: 10px auto; background: #333; border: 3px solid var(--ink); border-radius: 0 0 10px 10px; box-shadow: inset 0 5px 10px rgba(0,0,0,0.5); }
        .print-tray { margin-top: 10px; display: flex; justify-content: center; perspective: 800px; }
        .printed-paper { background: #fff; color: var(--ink); padding: 16px; border: 2px solid #aaa; border-radius: 4px; box-shadow: 0 6px 20px rgba(0,0,0,0.15); transform-origin: top; display: none; max-width: 100%; }
        .printed-paper.visible { display: block; animation: paperSlide 2.5s ease-out forwards; }
        .printed-paper.developing #generatedImage { opacity: 0.15; filter: blur(8px) grayscale(100%); }
        .printed-paper.developed #generatedImage { animation: photoReveal 3s ease-out forwards; }
        @keyframes paperSlide { 0% { transform: translateY(-60px); opacity: 0; } 100% { transform: translateY(0); opacity: 1; } }
        @keyframes photoReveal { 0% { opacity: 0.15; filter: blur(8px) grayscale(100%); } 100% { opacity: 1; filter: blur(0) grayscale(0%); } }
        #generatedImage { max-width: 100%; height: auto; border: 3px solid var(--ink); border-radius: 6px; display: block; }
        .print-meta { display: flex; justify-content: space-between; gap: 10px; margin-top: 10px; font-size: 0.85rem; color: #666; }
        .btn-download { margin-top: 12px; background: var(--ink); color: var(--electric-yellow); border: 3px solid var(--ink); font-family: 'Bangers', cursive; padding: 8px 24px; border-radius: 10px; width: auto; display: inline-block; cursor: pointer; box-shadow: 3px 3px 0 rgba(0,0,0,0.15); font-size: 1rem; letter-spacing: 0.08em; }
        .btn-download:hover { background: #333; transform: none; box-shadow: 3px 3px 0 rgba(0,0,0,0.15); }

        /* ---- RESET ---- */
        .reset-area { text-align: center; margin-top: 24px; }
        .btn-reset { background: #fff; color: var(--ink); border: 3px solid var(--ink); border-radius: 12px; padding: 10px 32px; font-family: 'Bangers', cursive; font-size: 1.1rem; letter-spacing: 0.06em; cursor: pointer; box-shadow: 4px 4px 0 rgba(0,0,0,0.1); width: auto; display: inline-block; }
        .btn-reset:hover { background: #f5f5f5; transform: none; box-shadow: 4px 4px 0 rgba(0,0,0,0.1); }

        /* ---- ANIMATIONS ---- */
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Beaker bubbles */
        .station.active .beaker-bubble { animation: bubbleUp 1.8s ease-in infinite; }
        .beaker-bubble.b2 { animation-delay: 0.5s; }
        .beaker-bubble.b3 { animation-delay: 1.1s; }
        @keyframes bubbleUp { 0% { transform: translateY(0); opacity: 0.6; } 100% { transform: translateY(-55px); opacity: 0; } }

        /* Paint drips */
        .station.active .drip { animation: dripFall 1.2s ease-in infinite; }
        .drip.d2 { animation-delay: 0.6s; }
        @keyframes dripFall { 0% { transform: translateY(0); opacity: 0.6; } 100% { transform: translateY(15px); opacity: 0; } }

        /* Printer illustration states */
        .station.active #printerLight { fill: var(--electric-yellow); animation: bulbFlicker 0.5s infinite alternate; }
        .station.done-bg #printerLight { fill: var(--happy-green); animation: none; }
        .station.done-bg #printerPaper { opacity: 1; }
        .station.done-bg #printerStar { opacity: 1; }

        /* ---- RESPONSIVE ---- */
        @media (max-width: 600px) {
            .factory-sign h1 { font-size: 1.8rem; }
            .professor-area { flex-direction: column; align-items: center; text-align: center; }
            .professor-speech::before, .professor-speech::after { display: none; }
            .station-illustration { float: none; margin: 0 auto 10px; display: block; }
            .station { padding: 18px 14px; }
        }
    </style>
</head>
<body>

    <div class="clouds">
        <div class="cloud cloud-1"></div>
        <div class="cloud cloud-2"></div>
        <div class="cloud cloud-3"></div>
    </div>

    <div class="factory-wrapper">

        <!-- SIGN -->
        <div class="factory-sign">
            <div class="sign-chain left"></div>
            <div class="sign-chain right"></div>
            <div class="sign-bolt left"></div>
            <div class="sign-bolt right"></div>
            <h1>Professor DataViz's<br>Laboratory</h1>
            <div class="tagline">Where questionable data meets beautiful art</div>
        </div>

        <!-- PROFESSOR + SPEECH BUBBLE -->
        <div class="professor-area">
            <svg class="professor-svg" viewBox="0 0 100 140" aria-label="Professor character">
                <rect x="25" y="65" width="50" height="55" rx="10" fill="#fff" stroke="#222" stroke-width="3"/>
                <line x1="50" y1="68" x2="42" y2="95" stroke="#ccc" stroke-width="2"/>
                <line x1="50" y1="68" x2="58" y2="95" stroke="#ccc" stroke-width="2"/>
                <rect x="56" y="85" width="12" height="10" rx="2" fill="none" stroke="#ccc" stroke-width="1.5"/>
                <line x1="60" y1="83" x2="60" y2="90" stroke="var(--science-blue)" stroke-width="2" stroke-linecap="round"/>
                <rect x="10" y="72" width="18" height="10" rx="5" fill="#fff" stroke="#222" stroke-width="3"/>
                <rect x="72" y="72" width="18" height="10" rx="5" fill="#fff" stroke="#222" stroke-width="3"/>
                <circle cx="10" cy="77" r="7" fill="#fdd9b5" stroke="#222" stroke-width="2"/>
                <circle cx="90" cy="77" r="7" fill="#fdd9b5" stroke="#222" stroke-width="2"/>
                <rect x="43" y="56" width="14" height="14" rx="4" fill="#fdd9b5" stroke="#222" stroke-width="2"/>
                <ellipse cx="50" cy="38" rx="25" ry="28" fill="#fdd9b5" stroke="#222" stroke-width="3"/>
                <ellipse cx="50" cy="18" rx="28" ry="14" fill="#aaa" stroke="#222" stroke-width="2"/>
                <ellipse cx="26" cy="25" rx="8" ry="12" fill="#aaa" stroke="#222" stroke-width="2"/>
                <ellipse cx="74" cy="25" rx="8" ry="12" fill="#aaa" stroke="#222" stroke-width="2"/>
                <circle cx="40" cy="37" r="9" fill="#fff" stroke="#222" stroke-width="2.5" opacity="0.9"/>
                <circle cx="60" cy="37" r="9" fill="#fff" stroke="#222" stroke-width="2.5" opacity="0.9"/>
                <line x1="49" y1="37" x2="51" y2="37" stroke="#222" stroke-width="2"/>
                <line x1="31" y1="36" x2="26" y2="33" stroke="#222" stroke-width="2"/>
                <line x1="69" y1="36" x2="74" y2="33" stroke="#222" stroke-width="2"/>
                <circle cx="41" cy="37" r="3" fill="#222"/>
                <circle cx="61" cy="37" r="3" fill="#222"/>
                <path d="M40 49 Q50 57 60 49" fill="none" stroke="#222" stroke-width="2" stroke-linecap="round"/>
                <path d="M38 45 Q44 50 50 45 Q56 50 62 45" fill="#888" stroke="#222" stroke-width="1.5"/>
                <ellipse cx="35" cy="125" rx="14" ry="6" fill="#333" stroke="#222" stroke-width="2"/>
                <ellipse cx="65" cy="125" rx="14" ry="6" fill="#333" stroke="#222" stroke-width="2"/>
                <rect x="33" y="115" width="10" height="14" rx="3" fill="#456" stroke="#222" stroke-width="2"/>
                <rect x="57" y="115" width="10" height="14" rx="3" fill="#456" stroke="#222" stroke-width="2"/>
            </svg>
            <div class="professor-speech">
                <span id="speechText">Welcome to my laboratory! Type in a subject and pull the lever. My machines will do the rest... probably.</span>
            </div>
        </div>

        <!-- FACTORY BUILDING -->
        <div class="factory-floor">
            <div class="brick-top"></div>
            <div class="stations-row">

                <!-- STATION 1: DATA ENGINE -->
                <div class="station" id="station1">
                    <svg class="station-illustration" width="80" height="90" viewBox="0 0 80 90" aria-label="Bubbling beaker">
                        <rect x="22" y="5" width="36" height="10" rx="3" fill="var(--metal-light)" stroke="#222" stroke-width="2"/>
                        <path d="M22 15 L10 70 Q8 82 20 85 L60 85 Q72 82 70 70 L58 15Z" fill="#e8f5e9" stroke="#222" stroke-width="3" opacity="0.8"/>
                        <ellipse cx="40" cy="72" rx="24" ry="8" fill="var(--goo-purple)" opacity="0.3"/>
                        <circle cx="32" cy="55" r="3" fill="var(--goo-purple)" opacity="0.4" class="beaker-bubble b1"/>
                        <circle cx="45" cy="60" r="2" fill="var(--goo-purple)" opacity="0.4" class="beaker-bubble b2"/>
                        <circle cx="38" cy="48" r="2.5" fill="var(--goo-purple)" opacity="0.4" class="beaker-bubble b3"/>
                    </svg>
                    <div class="station-header">
                        <div class="station-number blue">1<div class="spin-ring"></div></div>
                        <div><div class="station-title">Data Engine</div><div class="station-subtitle">Feed the machine your wildest topic</div></div>
                    </div>
                    <div class="input-area">
                        <div class="input-row">
                            <span>Visualize the</span>
                            <input type="text" id="inpAdjective" placeholder="adjective">
                            <input type="text" id="inpNoun" placeholder="noun">
                        </div>
                        <div class="input-row">
                            <select id="inpPrep"><option value="of">of</option><option value="in">in</option><option value="on">on</option><option value="at">at</option><option value="about">about</option><option value="during">during</option><option value="with">with</option><option value="without">without</option><option value="from">from</option><option value="for">for</option></select>
                            <input type="text" id="inpContext" placeholder="context">
                        </div>
                        <div class="input-row">
                            <span>Style:</span>
                            <select id="graphStyle">
                                <option value="crayon bar chart">Crayon Bar Chart</option>
                                <option value="hand-drawn pie chart">Messy Pie Chart</option>
                                <option value="scribbled line graph">Wobbly Line Graph</option>
                                <option value="scatter plot with stickers">Scatter Plot w/ Stickers</option>
                                <option value="crayon heatmap">Crayon Heatmap</option>
                                <option value="stacked graph with doodles">Stacked Graph</option>
                                <option value="Chernoff faces drawn by a child">Chernoff Faces</option>
                                <option value="hand-drawn geomap">Geomap</option>
                            </select>
                        </div>
                    </div>
                    <div class="lever-btn-wrapper">
                        <button class="lever-btn" id="leverBtn" onclick="pullLever()">
                            <div class="lever-base"></div>
                            <div class="lever-handle"><div class="lever-knob"></div></div>
                            <div class="lever-label">PULL TO START</div>
                        </button>
                    </div>
                    <div class="bulb-row"><div class="bulb" id="b1a"></div><div class="bulb" id="b1b"></div><div class="bulb" id="b1c"></div></div>
                    <div id="loader1" class="loading-text">Mixing the data potion...</div>
                    <div class="accordion">
                        <button class="accordion-header" type="button" aria-expanded="false" data-target="accordionBody1">View Dataset</button>
                        <div id="accordionBody1" class="accordion-body"><div id="output1" class="output-slot"></div><div id="sourceContainer"></div></div>
                    </div>
                </div>

                <!-- CONVEYOR 1 -->
                <div class="conveyor" id="conveyor1">
                    <div class="conveyor-belt"></div>
                    <div class="conveyor-rollers"><div class="roller"></div><div class="roller"></div><div class="roller"></div><div class="roller"></div><div class="roller"></div><div class="roller"></div></div>
                </div>

                <!-- STATION 2: ART LOGIC -->
                <div class="station locked" id="station2">
                    <svg class="station-illustration" width="80" height="90" viewBox="0 0 80 90" aria-label="Robot arm painting">
                        <rect x="55" y="0" width="20" height="15" rx="3" fill="var(--metal)" stroke="#222" stroke-width="2"/>
                        <rect x="60" y="12" width="10" height="30" rx="4" fill="var(--metal-light)" stroke="#222" stroke-width="2"/>
                        <circle cx="65" cy="42" r="7" fill="var(--metal)" stroke="#222" stroke-width="2"/>
                        <rect x="30" y="38" width="35" height="8" rx="4" fill="var(--metal-light)" stroke="#222" stroke-width="2"/>
                        <rect x="18" y="36" width="16" height="5" rx="2" fill="var(--wood)" stroke="#222" stroke-width="1.5"/>
                        <path d="M18 36 L12 33 L10 39 L18 41Z" fill="var(--science-blue)" stroke="#222" stroke-width="1.5"/>
                        <circle cx="12" cy="44" r="2" fill="var(--science-blue)" opacity="0.6" class="drip d1"/>
                        <circle cx="16" cy="48" r="1.5" fill="var(--goo-purple)" opacity="0.6" class="drip d2"/>
                        <rect x="5" y="55" width="45" height="32" rx="2" fill="#fff" stroke="#222" stroke-width="2"/>
                        <rect x="20" y="54" width="3" height="5" fill="var(--wood)" stroke="#222" stroke-width="1"/>
                        <path d="M12 65 Q20 60 28 67 Q36 74 42 65" fill="none" stroke="var(--danger-red)" stroke-width="2" stroke-linecap="round"/>
                        <path d="M10 75 Q22 70 35 77" fill="none" stroke="var(--science-blue)" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                    <div class="station-header">
                        <div class="station-number purple">2<div class="spin-ring"></div></div>
                        <div><div class="station-title">Art Logic Unit</div><div class="station-subtitle">Translating data into artistic instructions</div></div>
                    </div>
                    <div class="bulb-row"><div class="bulb" id="b2a"></div><div class="bulb" id="b2b"></div><div class="bulb" id="b2c"></div></div>
                    <div id="loader2" class="loading-text">Robot arm is painting...</div>
                    <div class="accordion">
                        <button class="accordion-header" type="button" aria-expanded="false" data-target="accordionBody2">View Art Prompt</button>
                        <div id="accordionBody2" class="accordion-body"><textarea id="promptOutput" readonly></textarea></div>
                    </div>
                </div>

                <!-- CONVEYOR 2 -->
                <div class="conveyor" id="conveyor2">
                    <div class="conveyor-belt"></div>
                    <div class="conveyor-rollers"><div class="roller"></div><div class="roller"></div><div class="roller"></div><div class="roller"></div><div class="roller"></div><div class="roller"></div></div>
                </div>

                <!-- STATION 3: PRINTER -->
                <div class="station locked" id="station3">
                    <svg class="station-illustration" width="80" height="90" viewBox="0 0 80 90" aria-label="Printer">
                        <rect x="5" y="20" width="70" height="40" rx="8" fill="#eee" stroke="#222" stroke-width="3"/>
                        <rect x="15" y="16" width="50" height="8" rx="2" fill="#ddd" stroke="#222" stroke-width="2"/>
                        <circle cx="60" cy="32" r="5" fill="#555" stroke="#222" stroke-width="1.5" id="printerLight"/>
                        <circle cx="18" cy="50" r="4" fill="var(--danger-red)" stroke="#222" stroke-width="1.5"/>
                        <circle cx="30" cy="50" r="4" fill="var(--happy-green)" stroke="#222" stroke-width="1.5"/>
                        <rect x="10" y="56" width="60" height="6" rx="2" fill="#333" stroke="#222" stroke-width="2"/>
                        <rect x="20" y="58" width="40" height="28" rx="1" fill="#fff" stroke="#222" stroke-width="1.5" id="printerPaper" opacity="0"/>
                        <polygon points="40,66 42,72 48,72 43,76 45,82 40,78 35,82 37,76 32,72 38,72" fill="var(--electric-yellow)" stroke="#222" stroke-width="1" id="printerStar" opacity="0"/>
                    </svg>
                    <div class="station-header">
                        <div class="station-number red">3<div class="spin-ring"></div></div>
                        <div><div class="station-title">The Printer</div><div class="station-subtitle">Rendering your masterpiece onto paper</div></div>
                    </div>
                    <div class="bulb-row"><div class="bulb" id="b3a"></div><div class="bulb" id="b3b"></div><div class="bulb" id="b3c"></div></div>
                    <div id="loader3" class="loading-text">Ink levels low... printing anyway...</div>
                </div>

            </div>

            <!-- PRINTER OUTPUT -->
            <div class="printer-station">
                <div class="printer-mouth"></div>
                <div class="print-tray">
                    <div id="paperSheet" class="printed-paper">
                        <img id="generatedImage" alt="Waiting for print job...">
                        <div class="print-meta">
                            <div id="printSource" class="print-source"></div>
                            <div id="printSubject"></div>
                        </div>
                        <button id="downloadBtn" class="btn-download" style="display:none;" onclick="downloadImage()">Download Print</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="reset-area">
            <button class="btn-reset" onclick="resetMachine()">Reset the Whole Factory</button>
        </div>
    </div>

    <div class="burst" id="burstEffect"></div>

    <script>
        const OPENAI_PROXY_ENDPOINT = "/.netlify/functions/openai";
        const OPENAI_TEXT_MODEL = "gpt-5";
        const OPENAI_IMAGE_MODEL = "gpt-image-1";
        const OPENAI_IMAGE_SIZE = "1024x1024";
        const OPENAI_IMAGE_QUALITY = location.hostname === "localhost" ? "low" : "auto";
        const OPENAI_IMAGE_FORMAT = "webp";
        const OPENAI_IMAGE_COMPRESSION = location.hostname === "localhost" ? 50 : 70;

        async function fetchWithRetry(url, options, maxRetries = 5) {
            let delay = 1000;
            for (let i = 0; i <= maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) return await response.json();
                    if (response.status === 403 || response.status === 401) {
                        const errData = await response.json();
                        throw new Error(`API KEY ERROR: ${errData.error?.message || "Missing or invalid key"}`);
                    }
                    if (response.status === 400) {
                        const errData = await response.json();
                        throw new Error(`BAD REQUEST: ${errData.error?.message || "Verify your prompt or settings."}`);
                    }
                    const errData = await response.json().catch(() => ({}));
                    throw new Error(`HTTP ${response.status}: ${errData.error?.message || "Request failed."}`);
                } catch (err) {
                    if (i === maxRetries || err.message.includes("API KEY") || err.message.includes("BAD REQUEST")) throw err;
                }
                await new Promise(resolve => setTimeout(resolve, delay));
                delay *= 2;
            }
        }

        let currentDataset = "", currentSubject = "", currentSourceInfo = "";
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator(), gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            const now = audioCtx.currentTime;
            if (type === 'click') { osc.type = 'square'; osc.frequency.setValueAtTime(400, now); osc.frequency.exponentialRampToValueAtTime(100, now + 0.1); gain.gain.setValueAtTime(0.05, now); gain.gain.exponentialRampToValueAtTime(0.001, now + 0.1); osc.start(now); osc.stop(now + 0.1); }
            else if (type === 'motor') { osc.type = 'sawtooth'; osc.frequency.setValueAtTime(80, now); osc.frequency.linearRampToValueAtTime(120, now + 0.5); gain.gain.setValueAtTime(0.05, now); gain.gain.linearRampToValueAtTime(0, now + 0.5); osc.start(now); osc.stop(now + 0.5); }
            else if (type === 'print') { osc.type = 'triangle'; osc.frequency.setValueAtTime(800, now); gain.gain.setValueAtTime(0.05, now); gain.gain.exponentialRampToValueAtTime(0.001, now + 0.2); osc.start(now); osc.stop(now + 0.2); }
            else if (type === 'lever') { osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, now); osc.frequency.exponentialRampToValueAtTime(400, now + 0.15); gain.gain.setValueAtTime(0.06, now); gain.gain.exponentialRampToValueAtTime(0.001, now + 0.2); osc.start(now); osc.stop(now + 0.2); }
            else if (type === 'success') { osc.type = 'sine'; osc.frequency.setValueAtTime(523, now); osc.frequency.setValueAtTime(659, now + 0.12); osc.frequency.setValueAtTime(784, now + 0.24); gain.gain.setValueAtTime(0.06, now); gain.gain.exponentialRampToValueAtTime(0.001, now + 0.4); osc.start(now); osc.stop(now + 0.4); }
            else if (type === 'explosion') { const bufferSize = audioCtx.sampleRate * 0.5, buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate), data = buffer.getChannelData(0); for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1; const noise = audioCtx.createBufferSource(); noise.buffer = buffer; const noiseGain = audioCtx.createGain(); noise.connect(noiseGain); noiseGain.connect(audioCtx.destination); noiseGain.gain.setValueAtTime(0.15, now); noiseGain.gain.exponentialRampToValueAtTime(0.001, now + 0.5); noise.start(now); }
        }

        /* ---- SPEECH ---- */
        const speeches = {
            welcome: "Welcome to my laboratory! Type in a subject and pull the lever. My machines will do the rest... probably.",
            pulling: "Ooh, excellent choice! Let's see what the data engine cooks up!",
            engine_done: "Data locked in! The conveyor belt is carrying it to the Art Logic Unit...",
            art_running: "My robot arm is translating your data into art instructions. Don't touch anything!",
            art_done: "Beautiful! The art prompt is ready. Sending it to the printer now...",
            printing: "The printer is working overtime! Stand back, this could get messy...",
            finished: "TA-DA! Another masterpiece from my laboratory! You can download it below.",
            error: "Something exploded! That wasn't supposed to happen... let's try again.",
            reset: "Back to square one! The machines are cooling down. What shall we create next?"
        };
        function setSpeech(key) {
            const el = document.getElementById('speechText');
            el.style.opacity = '0';
            setTimeout(() => { el.textContent = speeches[key] || key; el.style.opacity = '1'; }, 200);
        }

        /* ---- BURST ---- */
        function showBurst(text) {
            const burst = document.getElementById('burstEffect');
            burst.textContent = text;
            burst.style.top = (20 + Math.random() * 30) + '%';
            burst.style.left = (20 + Math.random() * 50) + '%';
            burst.classList.remove('show');
            void burst.offsetWidth;
            burst.classList.add('show');
            setTimeout(() => burst.classList.remove('show'), 1100);
        }

        /* ---- BULBS ---- */
        function setBulbs(stationId, state) {
            const a = document.getElementById(`b${stationId}a`), b = document.getElementById(`b${stationId}b`), c = document.getElementById(`b${stationId}c`);
            a.className = 'bulb'; b.className = 'bulb'; c.className = 'bulb';
            if (state === 'running') { a.classList.add('on-yellow'); b.classList.add('on-yellow'); c.classList.add('on-red'); }
            else if (state === 'done') { a.classList.add('on-green'); b.classList.add('on-green'); c.classList.add('on-green'); }
        }

        function setStationState(id, state) {
            const el = document.getElementById(`station${id}`);
            el.classList.remove('active', 'done-bg', 'locked');
            if (state === 'running') { el.classList.add('active'); setBulbs(id, 'running'); }
            else if (state === 'done') { el.classList.add('done-bg'); setBulbs(id, 'done'); }
            else if (state === 'locked') { el.classList.add('locked'); setBulbs(id, 'idle'); }
            else { setBulbs(id, 'idle'); }
        }

        function setConveyor(id, running) {
            const el = document.getElementById(`conveyor${id}`);
            if (running) el.classList.add('running'); else el.classList.remove('running');
        }

        function registerAccordions() {
            document.querySelectorAll('.accordion-header').forEach(header => {
                header.addEventListener('click', () => {
                    const targetId = header.dataset?.target;
                    const body = document.getElementById(targetId);
                    if (!body) return;
                    const isExpanded = header.getAttribute('aria-expanded') === 'true';
                    header.setAttribute('aria-expanded', (!isExpanded).toString());
                    body.classList.toggle('expanded', !isExpanded);
                });
            });
        }

        function smoothScrollTo(targetId, block = 'start') {
            const el = document.getElementById(targetId);
            if (el) setTimeout(() => el.scrollIntoView({ behavior: 'smooth', block }), 80);
        }

        function updatePrintMeta() {
            const srcEl = document.getElementById('printSource'), subjEl = document.getElementById('printSubject');
            if (srcEl) srcEl.textContent = currentSourceInfo ? `Source: ${currentSourceInfo}` : "";
            if (subjEl) subjEl.textContent = currentSubject ? `Subject: The ${currentSubject}` : "";
        }

        function ensureSource() {
            if (currentSourceInfo && currentSourceInfo.trim()) return;
            const pool = ["Imaginary Institute", "National Doodle Bureau", "Chartopia Research", "Crayon Metrics Lab", "Professor's Filing Cabinet", "Institute of Playful Stats", "The Data Dungeon", "Academy of Questionable Science"];
            currentSourceInfo = pool[Math.floor(Math.random() * pool.length)];
        }

        function downloadImage() {
            const img = document.getElementById('generatedImage');
            if (!img?.src) return;
            const link = document.createElement('a');
            link.href = img.src;
            link.download = `dataviz-${(currentSubject || 'visual').replace(/\s+/g, '-').toLowerCase()}.png`;
            document.body.appendChild(link); link.click(); link.remove();
        }

        function pullLever() {
            const lever = document.getElementById('leverBtn');
            if (lever.classList.contains('pulled')) return;
            lever.classList.add('pulled');
            playSound('lever');
            showBurst("CLUNK!");
            setTimeout(() => runMachine1(), 400);
        }

        function resetMachine() {
            playSound('click');
            currentDataset = ""; currentSubject = ""; currentSourceInfo = "";
            document.getElementById('leverBtn').classList.remove('pulled');
            setStationState(1, 'idle'); setStationState(2, 'locked'); setStationState(3, 'locked');
            setConveyor(1, false); setConveyor(2, false);
            document.getElementById('output1').textContent = '';
            document.getElementById('sourceContainer').innerHTML = '';
            document.getElementById('promptOutput').value = '';
            const paper = document.getElementById('paperSheet');
            paper.style.display = 'none'; paper.className = 'printed-paper';
            document.getElementById('generatedImage').src = '';
            const dlBtn = document.getElementById('downloadBtn');
            if (dlBtn) dlBtn.style.display = 'none';
            ['loader1','loader2','loader3'].forEach(id => document.getElementById(id).style.display = 'none');
            updatePrintMeta();
            setSpeech('reset');
        }

        async function runMachine1() {
            const adj = document.getElementById('inpAdjective').value || "average";
            const noun = document.getElementById('inpNoun').value || "objects";
            const prep = document.getElementById('inpPrep').value;
            const context = document.getElementById('inpContext').value || "the void";
            currentSubject = `${adj} ${noun} ${prep} ${context}`;
            setStationState(1, 'running'); playSound('motor'); setSpeech('pulling');
            document.getElementById('loader1').style.display = 'block';
            document.getElementById('sourceContainer').innerHTML = '';
            currentSourceInfo = ""; currentDataset = "";
            ensureSource();
            document.getElementById('output1').textContent = `Subject locked: The ${currentSubject}`;
            updatePrintMeta();
            setStationState(1, 'done'); showBurst("ZING!"); setSpeech('engine_done');
            setConveyor(1, true);
            document.getElementById('loader1').style.display = 'none';
            setStationState(2, 'idle');
            smoothScrollTo('station2');
            setTimeout(() => runMachine2(), 600);
        }

        async function runMachine2() {
            playSound('motor'); setStationState(2, 'running'); setSpeech('art_running');
            document.getElementById('loader2').style.display = 'block';
            const prompt = `Topic: "The ${currentSubject}". Generate a creative dataset and then a concise art prompt.\n\nFORMAT:\nDATA_START\nItem: Value\nDATA_END\nSOURCE_NAME: [Name]\nPROMPT_START\n[Crayon drawing prompt for a ${document.getElementById('graphStyle').value}]\nPROMPT_END`;
            try {
                const data = await fetchWithRetry(OPENAI_PROXY_ENDPOINT, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ endpoint: "responses", payload: { model: OPENAI_TEXT_MODEL, input: prompt } })
                });
                const extractTextFromOutput = (out) => {
                    if (!Array.isArray(out)) return "";
                    for (const item of out) {
                        if (item?.type === "message" && Array.isArray(item.content)) {
                            const part = item.content.find(p => p.type === "output_text") || item.content.find(p => p.type === "text") || item.content.find(p => typeof p.text === "string");
                            if (part?.text) return part.text;
                        }
                        if (typeof item?.text === "string") return item.text;
                    }
                    return "";
                };
                const text = data.output_text || extractTextFromOutput(data.output) || "";
                if (!text) throw new Error('Unexpected response (missing text)');
                if (text.includes("DATA_START") && text.includes("DATA_END")) {
                    currentDataset = text.split("DATA_START")[1].split("DATA_END")[0].trim();
                    document.getElementById('output1').textContent = currentDataset;
                }
                if (text.includes("SOURCE_NAME:")) currentSourceInfo = text.split("SOURCE_NAME:")[1]?.split("\n")[0].trim() || "";
                ensureSource();
                document.getElementById('sourceContainer').innerHTML = `<span class="source-tag">Source: ${currentSourceInfo}</span>`;
                updatePrintMeta();
                if (text.includes("PROMPT_START") && text.includes("PROMPT_END")) {
                    document.getElementById('promptOutput').value = text.split("PROMPT_START")[1].split("PROMPT_END")[0].trim();
                } else { document.getElementById('promptOutput').value = text.trim(); }
                setStationState(2, 'done'); showBurst("POW!"); playSound('success'); setSpeech('art_done');
                setConveyor(2, true); setStationState(3, 'idle');
                smoothScrollTo('station3');
                setTimeout(() => runMachine3(), 600);
            } catch (error) {
                setStationState(2, 'idle'); setSpeech('error'); showBurst("OOPS!");
            } finally { document.getElementById('loader2').style.display = 'none'; }
        }

        async function runMachine3() {
            const promptVal = document.getElementById('promptOutput').value;
            if (!promptVal) return;
            setStationState(3, 'running'); playSound('motor'); setSpeech('printing');
            document.getElementById('loader3').style.display = 'block';
            try {
                const body = { model: OPENAI_IMAGE_MODEL, prompt: `${promptVal}, crayon style drawing`, size: OPENAI_IMAGE_SIZE, quality: OPENAI_IMAGE_QUALITY, output_format: OPENAI_IMAGE_FORMAT, output_compression: OPENAI_IMAGE_COMPRESSION, response_format: "b64_json" };
                const data = await fetchWithRetry(OPENAI_PROXY_ENDPOINT, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ endpoint: "images/generations", payload: body })
                });
                const imageData = data.data?.[0]?.b64_json;
                if (!imageData) throw new Error("No image data returned.");
                document.getElementById('generatedImage').src = `data:image/png;base64,${imageData}`;
                const paper = document.getElementById('paperSheet');
                paper.className = 'printed-paper visible developing'; paper.style.display = 'block';
                const dlBtn = document.getElementById('downloadBtn');
                if (dlBtn) dlBtn.style.display = 'inline-block';
                setStationState(3, 'done'); playSound('explosion'); showBurst("BOOM!"); setSpeech('finished');
                smoothScrollTo('generatedImage', 'center');
                setTimeout(() => { paper.classList.remove('developing'); paper.classList.add('developed'); }, 3000);
            } catch (error) {
                console.error("Image Error:", error);
                setStationState(3, 'idle'); setSpeech('error'); showBurst("OOPS!");
            } finally { document.getElementById('loader3').style.display = 'none'; }
        }

        registerAccordions();
    </script>
</body>
</html>
